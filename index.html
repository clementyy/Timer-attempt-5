// Perfect Speedcubing Timer - React + TailwindCSS
// Features: Draw scramble, timer, solve history, event selection
// Libraries: react, react-dom, scrambler (for WCA scrambles), localForage

import React, { useState, useEffect, useRef } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import localforage from "localforage";
import { getScramble } from "scrambler"; // Assumed scramble generator

const events = ["3x3", "2x2", "4x4", "5x5", "6x6", "7x7", "Pyraminx", "Skewb", "Square-1", "Clock", "Megaminx"];

export default function TimerApp() {
  const [scramble, setScramble] = useState("");
  const [event, setEvent] = useState("3x3");
  const [solving, setSolving] = useState(false);
  const [time, setTime] = useState(0);
  const [start, setStart] = useState(null);
  const [history, setHistory] = useState([]);
  const interval = useRef(null);

  useEffect(() => {
    loadScramble();
    loadHistory();
  }, [event]);

  const loadScramble = () => {
    const newScramble = getScramble(event);
    setScramble(newScramble);
  };

  const loadHistory = async () => {
    const saved = await localforage.getItem(event);
    setHistory(saved || []);
  };

  const saveSolve = async (newSolve) => {
    const updated = [newSolve, ...history];
    setHistory(updated);
    await localforage.setItem(event, updated);
  };

  const handleKey = (e) => {
    if (e.code === "Space") {
      e.preventDefault();
      if (!solving) {
        setStart(Date.now());
        interval.current = setInterval(() => {
          setTime(Date.now() - start);
        }, 10);
        setSolving(true);
      } else {
        clearInterval(interval.current);
        const finalTime = Date.now() - start;
        setTime(finalTime);
        setSolving(false);
        saveSolve({ scramble, time: finalTime });
        loadScramble();
      }
    }
  };

  useEffect(() => {
    window.addEventListener("keydown", handleKey);
    return () => window.removeEventListener("keydown", handleKey);
  });

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-900 to-indigo-800 text-white flex flex-col items-center p-4">
      <h1 className="text-4xl font-bold mt-6">Perfect Cubing Timer</h1>

      <div className="mt-4">
        <select
          className="p-2 rounded-xl bg-white text-black"
          value={event}
          onChange={(e) => setEvent(e.target.value)}
        >
          {events.map((ev) => (
            <option key={ev} value={ev}>{ev}</option>
          ))}
        </select>
      </div>

      <Card className="mt-6 p-6 w-full max-w-xl text-center">
        <CardContent>
          <p className="text-lg font-mono whitespace-pre-wrap">{scramble}</p>
          <div className="text-6xl mt-8 font-bold">
            {(time / 1000).toFixed(2)}s
          </div>
          <p className="text-sm mt-2 text-gray-300">Press Space to start/stop</p>
        </CardContent>
      </Card>

      <div className="mt-10 w-full max-w-xl">
        <h2 className="text-2xl mb-4">Solve History</h2>
        <div className="space-y-2">
          {history.slice(0, 5).map((solve, idx) => (
            <div
              key={idx}
              className="bg-white text-black p-3 rounded-xl flex justify-between items-center shadow-lg"
            >
              <span className="font-mono">{(solve.time / 1000).toFixed(2)}s</span>
              <span className="text-xs text-gray-500">{solve.scramble.slice(0, 30)}...</span>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
